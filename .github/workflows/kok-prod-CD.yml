name: kok-prod-CD (Deploy to Prod - Blue-Green Auto)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Create SSH key file
        run: echo "${{ secrets.NCP_KEY }}" > /tmp/NCP_KEY.pem

      - name: Set permissions for SSH key file
        run: chmod 600 /tmp/NCP_KEY.pem

      - name: Upload `docker-compose.yml` & `nginx.conf` to NCP
        run: |
          scp -i /tmp/NCP_KEY.pem -o StrictHostKeyChecking=no infra/docker-compose-prod.yml ${{ secrets.NCP_USER }}@${{ secrets.NCP_HOST }}:${{ secrets.COMPOSE_FILE_PATH }}
          scp -i /tmp/NCP_KEY.pem -o StrictHostKeyChecking=no infra/nginx/nginx.conf ${{ secrets.NCP_USER }}@${{ secrets.NCP_HOST }}:${{ secrets.COMPOSE_FILE_PATH }}/nginx.conf

      - name: Deploy to NCP (Blue-Green Auto Switch)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.NCP_HOST }}
          username: ${{ secrets.NCP_USER }}
          key: ${{ secrets.NCP_KEY }}
          script: |
            cd ${{ secrets.COMPOSE_FILE_PATH }}

            # í˜„ì¬ ì‚¬ìš© ì¤‘ì¸ Blue/Green í™˜ê²½ ê°ì§€
            CURRENT_ENV=$(grep -o 'server kok-[a-z]\+' nginx.conf | awk '{print $2}')
            echo "í˜„ì¬ ì‚¬ìš© ì¤‘ì¸ í™˜ê²½: $CURRENT_ENV"
              
            if [[ "$CURRENT_ENV" == "kok-blue" ]]; then
              NEW_ENV="kok-green"
              OLD_ENV="kok-blue"
              COMPOSE_FILE="docker-compose-green.yml"
              NEW_PORT=8082
            else
              NEW_ENV="kok-blue"
              OLD_ENV="kok-green"
              COMPOSE_FILE="docker-compose-blue.yml"
              NEW_PORT=8081
            fi
            
            echo "ìƒˆë¡œìš´ í™˜ê²½ìœ¼ë¡œ ë°°í¬: $NEW_ENV"
            
            # ìƒˆë¡œìš´ í™˜ê²½ì— ì»¨í…Œì´ë„ˆ ë°°í¬
            sudo docker compose -f $COMPOSE_FILE pull
            sudo docker compose -f $COMPOSE_FILE up -d
              
            # Health Check ì‹¤í–‰
            echo "ğŸš€ Health Check ì‹¤í–‰ ì¤‘..."
            sleep 30
            if ! curl -s http://localhost:$NEW_PORT/health_check | grep "Success"; then
              echo "ğŸš¨ Health Check ì‹¤íŒ¨! ë¡¤ë°±ì„ ì‹¤í–‰í•©ë‹ˆë‹¤."
              sudo docker compose stop $NEW_ENV
              sudo docker compose rm -f $NEW_ENV
              exit 1
            fi
              
            # âœ… Nginx ì„¤ì • íŒŒì¼ ìë™ ìˆ˜ì • (íŠ¸ë˜í”½ì„ ìƒˆë¡œìš´ í™˜ê²½ìœ¼ë¡œ ë³€ê²½)
            echo "âœ… íŠ¸ë˜í”½ì„ $NEW_ENVë¡œ ë³€ê²½ ì¤‘..."
            sudo sed -i "s/server $OLD_ENV:8080/server $NEW_ENV:8080/" nginx.conf
            
            # âœ… ë¬´ì¤‘ë‹¨ìœ¼ë¡œ Nginx ì„¤ì • ë°˜ì˜
            echo "ğŸ”„ Nginx ì„¤ì •ì„ ë¬´ì¤‘ë‹¨ìœ¼ë¡œ ì ìš©..."
            sudo docker exec kok-nginx nginx -s reload
            
            # âœ… ê¸°ì¡´ í™˜ê²½ ì¤‘ì§€ ë° ì •ë¦¬
            echo "ğŸ›‘ ê¸°ì¡´ í™˜ê²½($OLD_ENV) ì¤‘ì§€..."
            sudo docker compose stop $OLD_ENV
            sudo docker compose rm -f $OLD_ENV